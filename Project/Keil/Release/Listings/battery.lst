C51 COMPILER V9.60.7.0   BATTERY                                                           05/26/2025 16:52:39 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE BATTERY
OBJECT MODULE PLACED IN .\Release\Objects\battery.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\battery.c LARGE OPTIMIZE(9,SIZE) BROWSE ORDER INTVECTOR(0X000
                    -C) INCDIR(..\..\Libraries\Include;..\..\User;..\..\User\lib;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Relea
                    -se\Listings\battery.lst) OBJECT(.\Release\Objects\battery.obj)

line level    source

   1          #include "battery.h"
   2          
   3          volatile u32 battery_scan_time_cnt = 0; // ç”µæ± æ‰«ææ—¶é—´è®¡æ—¶ï¼ˆåœ¨å®šæ—¶å™¨ä¸­ç´¯åŠ ï¼‰
   4          
   5          //
   6          
   7          // å°†adå€¼è½¬æ¢ä¸ºå¯¹åº”çš„ç”µå‹å€¼
   8          // arg_adc_val ï¼š adå€¼
   9          u8 conver_adc_val_to_voltage(u16 arg_adc_val)
  10          {
  11   1          /*
  12   1              é‡‡é›†åˆ°çš„adå€¼èŒƒå›´ï¼š0~4095
  13   1              adå€¼å¯¹åº”çš„ç”µå‹ï¼š 0 ~ MAX_VOLTAGE_OF_BATTERY
  14   1              é‚£ä¹ˆ æ¯å•ä½adå€¼å¯¹åº” MAX_VOLTAGE_OF_BATTERY / 4096
  15   1          */
  16   1          return (u32)arg_adc_val * MAX_VOLTAGE_OF_BATTERY / 4096;
  17   1      }
  18          
  19          // å°†ç”µæ± ç”µå‹è½¬æ¢ä¸ºå¯¹åº”çš„ç™¾åˆ†æ¯”
  20          // voltageï¼š 0~255 ï¼Œ å¯¹åº”0~25.5V
  21          u8 conver_voltage_of_battery_to_percentage(u8 voltage)
  22          {
  23   1          // ç”¨ç”µæ± ç”µå‹voltageé™¤ä»¥MAX_VOLTAGE_OF_BATTERYï¼Œå¾—åˆ°å æ¯”ï¼Œå†ä¹˜ä»¥100ï¼Œå¾—åˆ°ç™¾åˆ†æ¯”
  24   1          u8 tmp = (u16)voltage * 100 / MAX_VOLTAGE_OF_BATTERY;
  25   1          if (tmp >= 98)
  26   1          {
  27   2              // å¦‚æœç”µé‡ç™¾åˆ†æ¯”å¤§äº 98%ï¼Œå½“ä½œ100%ç”µé‡å¤„ç†
  28   2              tmp = 100;
  29   2          }
  30   1      
  31   1          return tmp;
  32   1      }
  33          
  34          void battery_scan(void)
  35          {
  36   1          u8 voltage_of_battery = 0;        // å­˜æ”¾ç”µæ± ç”µå‹
  37   1          u8 cur_percentage_of_battery = 0; // å­˜æ”¾å½“å‰ç”µæ± ç”µé‡ç™¾åˆ†æ¯”
  38   1      
  39   1          static volatile u32 battery_scan_cnt = 0; // è®°å½•ç”µæ± ç”µå‹æ‰«ææ¬¡æ•°
  40   1          static volatile u32 battery_val = 0; // ç´¯åŠ æ¯æ¬¡é‡‡é›†åˆ°çš„adå€¼ï¼Œåˆ°äº†ç”µæ± æ‰«ææ—¶é—´æ—¶ï¼Œ
             -ç›´æ¥æ±‚å¹³å‡å€¼
  41   1      
  42   1          adc_sel_pin(ADC_PIN_BATTERY);
  43   1          battery_val += adc_getval(); // å¯èƒ½è¦é˜²æ­¢è®¡æ•°æº¢å‡º
  44   1          battery_scan_cnt++; // ä¸Šé¢é‡‡é›†åˆ°ä¸€æ¬¡adå€¼ä¹‹åï¼Œè¿™é‡ŒåŠ ä¸€è¡¨ç¤ºé‡‡é›†äº†ä¸€æ¬¡
  45   1          if (battery_scan_time_cnt >= BATTERY_SCAN_UPDATE_TIME_MS) // å¦‚æœåˆ°äº†ç”µæ± æ•°æ®çš„æ›´æ–°æ—¶é—´ï¼
             -ˆæ›´æ–°/å‘é€ç”µæ± æ•°æ®çš„æ—¶é—´ï¼‰
  46   1          {
  47   2              battery_val /= battery_scan_cnt; // å–å¹³å‡æ•°
  48   2              voltage_of_battery = conver_adc_val_to_voltage(battery_val);
  49   2              cur_percentage_of_battery = conver_voltage_of_battery_to_percentage(voltage_of_battery);
  50   2              battery_val = 0;           // æ¸…ç©ºæ•°å€¼
  51   2              battery_scan_cnt = 0;      // æ¸…ç©ºè®¡æ•°å€¼
C51 COMPILER V9.60.7.0   BATTERY                                                           05/26/2025 16:52:39 PAGE 2   

  52   2              battery_scan_time_cnt = 0; // æ¸…ç©ºæ—¶é—´è®¡æ•°å€¼
  53   2      
  54   2              fun_info.battery = cur_percentage_of_battery;
  55   2              fun_info.voltage_of_battery = voltage_of_battery;
  56   2      
  57   2              // printf("cur voltage of battery : %bu\n", voltage_of_battery);
  58   2              // printf("cur percent of battery : %bu\n", cur_percentage_of_battery);
  59   2      
  60   2              flag_get_voltage_of_battery = 1;
  61   2              flag_get_battery = 1;
  62   2          }
  63   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    231    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     12       2
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
