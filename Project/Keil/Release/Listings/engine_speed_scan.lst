C51 COMPILER V9.60.7.0   ENGINE_SPEED_SCAN                                                 05/24/2025 16:58:02 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE ENGINE_SPEED_SCAN
OBJECT MODULE PLACED IN .\Release\Objects\engine_speed_scan.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\engine_speed_scan.c LARGE OPTIMIZE(9,SIZE) BROWSE ORDER INTVE
                    -CTOR(0X000C) INCDIR(..\..\Libraries\Include;..\..\User;..\..\User\lib;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRI
                    -NT(.\Release\Listings\engine_speed_scan.lst) OBJECT(.\Release\Objects\engine_speed_scan.obj)

line level    source

   1          #include "engine_speed_scan.h"
   2          
   3          // å‘åŠ¨æœºæ¯è½¬ä¸€åœˆï¼Œèƒ½æ£€æµ‹åˆ°çš„è„‰å†²ä¸ªæ•°
   4          #ifndef ENGINE_SPEED_SCAN_PULSE_PER_TURN
              #define ENGINE_SPEED_SCAN_PULSE_PER_TURN (16)
              #endif
   7          
   8          volatile u16 engine_scan_time_cnt = 0;        // å‘åŠ¨æœºè½¬é€Ÿæ‰«ææ—¶ï¼Œç”¨åˆ°çš„æ—¶é—´è®¡æ•°å€¼ï¼Œä¼š
             -åœ¨å®šæ—¶å™¨ä¸­æ–­ä¸­ç´¯åŠ 
   9          volatile u16 engine_actual_scan_time_cnt = 0; // å­˜æ”¾å®é™…çš„å‘åŠ¨æœºè½¬é€Ÿæ‰«æç”¨æ—¶
  10          
  11          // æ ‡å¿—ä½ï¼Œæ˜¯å¦æœ‰æ›´æ–°è„‰å†²è®¡æ•°,ç”±å®šæ—¶å™¨æ¥ç½®ä½
  12          // 0--æœªæ›´æ–°è„‰å†²è®¡æ•°ï¼Œ1--æœ‰æ–°çš„è„‰å†²è®¡æ•°
  13          volatile bit flag_is_update_engine_pulse_cnt = 0;
  14          /*
  15              å­˜æ”¾ æ£€æµ‹åˆ°çš„å‘é€æœºè½¬é€Ÿçš„è„‰å†²è®¡æ•°å€¼ï¼Œä¼šåœ¨ä¸­æ–­å†…ç´¯åŠ 
  16              ä½¿ç”¨äº†åŒç¼“å†²ï¼Œ[0]ç”¨åœ¨å®šæ—¶å™¨ä¸­æ–­ä¸­ï¼Œ[1]ç”¨åœ¨å‘åŠ¨æœºè½¬é€Ÿå¤„ç†å‡½æ•°ä¸­
  17              å½“ flag_is_update_engine_pulse_cnt == 1æ—¶ï¼Œè¯´æ˜å·²ç»æœ‰æ•°æ®æ›´æ–°
  18          */
  19          volatile u32 detect_engine_pulse_cnt[2] = {0};
  20          
  21          // å‘åŠ¨æœºè½¬é€Ÿçš„ç›¸å…³é…ç½®
  22          void engine_speed_scan_config(void)
  23          {
  24   1      #if 1 // ä½¿ç”¨å®šæ—¶å™¨æ‰«æIOç”µå¹³çš„æ–¹å¼
  25   1      
  26   1          P0_MD0 &= ~GPIO_P02_MODE_SEL(0x3); // è¾“å…¥æ¨¡å¼
  27   1      
  28   1      #endif // ä½¿ç”¨å®šæ—¶å™¨æ‰«æIOç”µå¹³çš„æ–¹å¼
  29   1      }
  30          
  31          // å‘åŠ¨æœºè½¬é€Ÿæ‰«æ
  32          void engine_speed_scan(void)
  33          {
  34   1      #define CONVER_ONE_MINUTE_TO_MS (60000) // å°†1minè½¬æ¢æˆä»¥msä¸ºå•ä½çš„æ•°æ®
  35   1          volatile u32 rpm = 0;
  36   1          static volatile u8 engine_speed_scan_cnt = 0; // é‡å¤æ‰«æçš„æ£€æµ‹æ¬¡æ•°(ç”¨äºæ»¤æ³¢)
  37   1          static volatile u32 cur_rpm_average = 0;      // å­˜æ”¾å‘åŠ¨æœºè½¬é€Ÿçš„å¹³å‡å€¼
  38   1      
  39   1          if (flag_is_update_engine_pulse_cnt)
  40   1          {
  41   2              // å¦‚æœæœ‰æ•°æ®æ›´æ–°
  42   2              flag_is_update_engine_pulse_cnt = 0; // æ¸…é™¤æ ‡å¿—ä½
  43   2      
  44   2              /*
  45   2                  (1min / 1minè½¬è¿‡çš„åœˆæ•°) == (æ‰«ææ—¶é—´ / æ‰«ææ—¶é—´å†…çš„è½¬è¿‡çš„åœˆæ•°)
  46   2                  1minè½¬è¿‡çš„åœˆæ•° == 1min * æ‰«ææ—¶é—´å†…è½¬è¿‡çš„åœˆæ•° / æ‰«ææ—¶é—´
  47   2                  1minè½¬è¿‡çš„åœˆæ•° == 1min * (æ‰«ææ—¶é—´å†…é‡‡é›†åˆ°çš„è„‰å†²ä¸ªæ•° / å‘åŠ¨æœºè½¬è¿‡ä¸€åœˆ
             -å¯¹åº”çš„è„‰å†²ä¸ªæ•°) / æ‰«ææ—¶é—´
  48   2                  è½¬æ¢æˆå•ç‰‡æœºèƒ½è®¡ç®—çš„å½¢å¼ï¼š
  49   2                  1minè½¬è¿‡çš„åœˆæ•° == æ‰«ææ—¶é—´å†…é‡‡é›†åˆ°çš„è„‰å†²ä¸ªæ•° * 1min / å‘åŠ¨æœºè½¬è¿‡ä¸€åœˆå
             -¯¹åº”çš„è„‰å†²ä¸ªæ•° / æ‰«ææ—¶é—´
  50   2                  1minè½¬è¿‡çš„åœˆæ•° == æ‰«ææ—¶é—´å†…é‡‡é›†åˆ°çš„è„‰å†²ä¸ªæ•° * 1min / æ‰«ææ—¶é—´ / å‘åŠ¨æ
C51 COMPILER V9.60.7.0   ENGINE_SPEED_SCAN                                                 05/24/2025 16:58:02 PAGE 2   

             -œºè½¬è¿‡ä¸€åœˆå¯¹åº”çš„è„‰å†²ä¸ªæ•°
  51   2              */
  52   2      
  53   2      #if USE_MY_DEBUG
              
                      // if (detect_engine_pulse_cnt[1])
                      // {
                      //     printf("pulse_cnt %lu \n", detect_engine_pulse_cnt[1]);
                      //     printf("engine actual scan time %u\n",engine_actual_scan_time_cnt);
                      // }
              
              #endif // #if USE_MY_DEBUG
  62   2      
  63   2              rpm = detect_engine_pulse_cnt[1] * (CONVER_ONE_MINUTE_TO_MS / ENGINE_SPEED_SCAN_PULSE_PER_TURN) / 
             -engine_actual_scan_time_cnt;
  64   2              if (engine_speed_scan_cnt < ENGINE_SPEED_SCAN_FILTER_CNT)
  65   2              {
  66   3                  // å¦‚æœæœªè¾¾åˆ°é‡å¤æ‰«æçš„æ£€æµ‹æ¬¡æ•°
  67   3                  engine_speed_scan_cnt++;
  68   3                  cur_rpm_average += rpm;
  69   3      
  70   3                  // if (rpm)
  71   3                  // {
  72   3                  //     printf("ori rpm %lu\n", rpm);
  73   3                  // }
  74   3              }
  75   2              else
  76   2              {
  77   3                  // å¦‚æœè¾¾åˆ°çš„é‡å¤æ‰«æçš„æ£€æµ‹æ¬¡æ•°
  78   3                  cur_rpm_average /= ENGINE_SPEED_SCAN_FILTER_CNT;
  79   3      
  80   3                  engine_speed_scan_cnt = 0; // æ¸…é™¤æ‰«ææ¬¡æ•°çš„è®¡æ•°å€¼
  81   3      
  82   3                  // é™åˆ¶å¾…å‘é€çš„å‘åŠ¨æœºè½¬é€Ÿ
  83   3                  if (cur_rpm_average >= 65535)
  84   3                  {
  85   4                      cur_rpm_average = 65535;
  86   4                  }
  87   3      
  88   3      #ifdef USE_MY_DEBUG
  89   3      #if USE_MY_DEBUG
              
                          if (cur_rpm_average != 0)
                          {
                              printf("engine speed %lu rpm\n", cur_rpm_average);
                          }
              
              #endif // #if USE_MY_DEBUG
  97   3      #endif // #ifdef USE_MY_DEBUG
  98   3      
  99   3                  fun_info.engine_speeed = cur_rpm_average; // å‘å…¨å±€å˜é‡å­˜æ”¾å‘åŠ¨æœºè½¬é€Ÿ
 100   3                  cur_rpm_average = 0;
 101   3      
 102   3                  flag_get_engine_speed = 1; // å‘é€å‘åŠ¨æœºè½¬é€Ÿ
 103   3              }
 104   2          }
 105   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    179    ----
   CONSTANT SIZE    =   ----    ----
C51 COMPILER V9.60.7.0   ENGINE_SPEED_SCAN                                                 05/24/2025 16:58:02 PAGE 3   

   XDATA SIZE       =     17       4
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
