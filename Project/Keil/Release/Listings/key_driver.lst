C51 COMPILER V9.60.7.0   KEY_DRIVER                                                        05/21/2025 18:01:22 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE KEY_DRIVER
OBJECT MODULE PLACED IN .\Release\Objects\key_driver.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\Hardware\key_driver.c LARGE OPTIMIZE(9,SIZE) BROWSE INTVECTOR(0X00
                    -0C) INCDIR(..\..\Libraries\Include;..\..\User;..\..\User\lib;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Rele
                    -ase\Listings\key_driver.lst) OBJECT(.\Release\Objects\key_driver.obj)

line level    source

   1          #include "key_driver.h"
   2          
   3          
   4          
   5          enum
   6          {
   7              KEY_SCAN_STATUS_NONE = 0,       // æ— ç‰¹æ®ŠçŠ¶æ€
   8              KEY_SCAN_STATUS_TO_NOTIFY,      // å‘é€æŒ‰é”®æ¶ˆæ¯
   9              KEY_SCAN_STATUS_TO_END_OF_SCAN, // æŒ‰é”®æ‰«æç»“æŸï¼Œè¿›è¡Œæ”¶å°¾å¤„ç†
  10          };
  11          
  12          static volatile u8 is_key_active = 0; // æŒ‰é”®æ˜¯å¦æœ‰æ•ˆçš„è®¡æ•°å€¼
  13          
  14          //=======================================================//
  15          // æŒ‰é”®æ‰«æå‡½æ•°: æ‰«ææ‰€æœ‰æ³¨å†Œçš„æŒ‰é”®é©±åŠ¨
  16          //=======================================================//
  17          static void key_driver_scan(void *_scan_para)
  18          {
  19   1          struct key_driver_para *scan_para = (struct key_driver_para *)_scan_para;
  20   1      
  21   1          u8 key_event = 0;          // å­˜æ”¾å¾…å‘é€çš„æŒ‰é”®äº‹ä»¶
  22   1          u8 cur_key_value = NO_KEY; // å­˜æ”¾å¾…å‘é€çš„æŒ‰é”®é”®å€¼
  23   1          u8 key_value = 0;
  24   1          // struct sys_event e;
  25   1      
  26   1          u8 key_scan_status = KEY_SCAN_STATUS_NONE; // çŠ¶æ€æœºï¼Œè´Ÿè´£æŽ§åˆ¶è¯¥å‡½æ•°å†…çš„è·³è½¬æ“ä½œ
  27   1      
  28   1          // å¦‚æžœæ‰«ææ—¶é—´æœªåˆ°æ¥ï¼Œä¸æ‰§è¡ŒæŒ‰é”®æ‰«æ
  29   1          if (scan_para->cur_scan_times < scan_para->scan_times)
  30   1          {
  31   2              return;
  32   2          }
  33   1      
  34   1          scan_para->cur_scan_times = 0; // æ¸…ç©ºæ‰«ææ—¶é—´
  35   1      
  36   1          cur_key_value = scan_para->get_value(); // è°ƒç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„èŽ·å–é”®å€¼å‡½æ•°
  37   1      
  38   1          // åˆ¤æ–­æŒ‰é”®æ˜¯å¦æœ‰æ•ˆ
  39   1          if (cur_key_value != NO_KEY)
  40   1          {
  41   2              is_key_active = 35; // 35*10Ms
  42   2          }
  43   1          else if (is_key_active)
  44   1          {
  45   2              is_key_active--;
  46   2          }
  47   1      
  48   1          //===== æŒ‰é”®æ¶ˆæŠ–å¤„ç†
  49   1          if (cur_key_value != scan_para->filter_value && scan_para->filter_time)
  50   1          {
  51   2              // å½“å‰æŒ‰é”®å€¼ä¸Žä¸Šä¸€æ¬¡æŒ‰é”®å€¼å¦‚æžœä¸ç›¸ç­‰, é‡æ–°æ¶ˆæŠ–å¤„ç†, æ³¨æ„filter_time != 0
             -;
  52   2              scan_para->filter_cnt = 0;               // æ¶ˆæŠ–æ¬¡æ•°æ¸…0, é‡æ–°å¼€å§‹æ¶ˆæŠ–
C51 COMPILER V9.60.7.0   KEY_DRIVER                                                        05/21/2025 18:01:22 PAGE 2   

  53   2              scan_para->filter_value = cur_key_value; // è®°å½•ä¸Šä¸€æ¬¡çš„æŒ‰é”®å€¼
  54   2              return;                                  // ç¬¬ä¸€æ¬¡æ£€æµ‹, è¿”å›žä¸åšå¤„ç†
  55   2          }
  56   1      
  57   1          // å½“å‰æŒ‰é”®å€¼ä¸Žä¸Šä¸€æ¬¡æŒ‰é”®å€¼ç›¸ç­‰, filter_cntå¼€å§‹ç´¯åŠ ;
  58   1          if (scan_para->filter_cnt < scan_para->filter_time)
  59   1          {
  60   2              scan_para->filter_cnt++;
  61   2              return;
  62   2          }
  63   1      
  64   1          //===== æŒ‰é”®æ¶ˆæŠ–ç»“æŸ, å¼€å§‹åˆ¤æ–­æŒ‰é”®ç±»åž‹(å•å‡», åŒå‡», é•¿æŒ‰, å¤šå‡», HOLD, (é•¿æŒ‰/HOL
             -D)æŠ¬èµ·)
  65   1          if (cur_key_value != scan_para->last_key) // å¦‚æžœå½“å‰é”®å€¼ä¸Žä¸Šä¸€æ¬¡æ‰«æçš„é”®å€¼ä¸ä¸€æ ·ï¼Œ
             -è¯´æ˜Žæœ‰æŒ‰é”®æŒ‰ä¸‹
  66   1          {
  67   2              /*
  68   2                  å¦‚æžœå½“å‰çš„é”®å€¼ä¸ºç©ºï¼Œä¸Šä¸€æ¬¡çš„é”®å€¼åˆä¸Žå½“å‰çš„é”®å€¼ä¸ä¸€æ ·ï¼Œè¯´æ˜ŽæŒ‰é”®æ
             -¾å¼€
  69   2                  cur_key = NO_KEY; last_key = valid_key -> æŒ‰é”®è¢«æŠ¬èµ·
  70   2              */
  71   2              if (cur_key_value == NO_KEY)
  72   2              {
  73   3      
  74   3                  if (scan_para->press_cnt >= scan_para->long_time)
  75   3                  { // é•¿æŒ‰/HOLDçŠ¶æ€ä¹‹åŽè¢«æŒ‰é”®æŠ¬èµ·;
  76   4                      key_event = KEY_EVENT_UP;
  77   4                      key_value = scan_para->last_key;
  78   4                      // goto _notify; // å‘é€æŠ¬èµ·æ¶ˆæ¯
  79   4                      key_scan_status = KEY_SCAN_STATUS_TO_NOTIFY; // è·³è½¬åˆ°å‘é€æŒ‰é”®äº‹ä»¶çš„æ“ä½œ
  80   4                  }
  81   3      
  82   3                  if (KEY_SCAN_STATUS_NONE == key_scan_status) // å¦‚æžœæ²¡æœ‰ç‰¹æ®Šæ“ä½œ
  83   3                  {
  84   4                      scan_para->click_delay_cnt = 1; // æŒ‰é”®ç­‰å¾…ä¸‹æ¬¡è¿žå‡»å»¶æ—¶å¼€å§‹
  85   4                  }
  86   3              }
  87   2              else
  88   2              {
  89   3                  /*
  90   3                      å¦‚æžœå½“å‰çš„é”®å€¼ä¸ä¸ºç©ºï¼Œä¸Šä¸€æ¬¡çš„é”®å€¼åˆä¸Žå½“å‰çš„é”®å€¼ä¸ä¸€æ ·ï¼Œè¯´æ˜Ž
             -æŒ‰é”®æŒ‰ä¸‹
  91   3                      cur_key = valid_key, last_key = NO_KEY -> æŒ‰é”®è¢«æŒ‰ä¸‹
  92   3                  */
  93   3                  scan_para->press_cnt = 1; // ç”¨äºŽåˆ¤æ–­longå’Œholdäº‹ä»¶çš„è®¡æ•°å™¨é‡æ–°å¼€å§‹è®¡æ—¶;
  94   3                  if (cur_key_value != scan_para->notify_value)
  95   3                  { // ç¬¬ä¸€æ¬¡å•å‡»/è¿žå‡»æ—¶æŒ‰ä¸‹çš„æ˜¯ä¸åŒæŒ‰é”®, å•å‡»æ¬¡æ•°é‡æ–°å¼€å§‹è®¡æ•°
  96   4                      scan_para->click_cnt = 1;
  97   4                      scan_para->notify_value = cur_key_value;
  98   4                  }
  99   3                  else
 100   3                  {
 101   4                      scan_para->click_cnt++; // å•å‡»æ¬¡æ•°ç´¯åŠ 
 102   4                  }
 103   3              }
 104   2      
 105   2              // goto _scan_end; // è¿”å›ž, ç­‰å¾…å»¶æ—¶æ—¶é—´åˆ°
 106   2              if (KEY_SCAN_STATUS_NONE == key_scan_status)
 107   2              {
 108   3                  key_scan_status = KEY_SCAN_STATUS_TO_END_OF_SCAN; // è¿”å›ž, ç­‰å¾…å»¶æ—¶æ—¶é—´åˆ°
 109   3              }
 110   2          }
C51 COMPILER V9.60.7.0   KEY_DRIVER                                                        05/21/2025 18:01:22 PAGE 3   

 111   1          else
 112   1          {
 113   2              /*
 114   2                  å¦‚æžœå½“å‰èŽ·å–çš„é”®å€¼ä¸Žä¸Šæ¬¡èŽ·å–çš„é”®å€¼ä¸€æ ·ï¼Œè¯´æ˜ŽæŒ‰é”®åœ¨é•¿æŒ‰æˆ–æ˜¯æŒ‰é”®æ
             -œªæŒ‰ä¸‹
 115   2                  cur_key = last_key -> æ²¡æœ‰æŒ‰é”®æŒ‰ä¸‹/æŒ‰é”®é•¿æŒ‰(HOLD)
 116   2              */
 117   2              if (cur_key_value == NO_KEY)
 118   2              {
 119   3                  // last_key = NO_KEY; cur_key = NO_KEY -> æ²¡æœ‰æŒ‰é”®æŒ‰ä¸‹
 120   3                  if (scan_para->click_cnt > 0)
 121   3                  { // æœ‰æŒ‰é”®éœ€è¦æ¶ˆæ¯éœ€è¦å¤„ç†
 122   4      
 123   4                      // å¦‚æžœåªå“åº”å•å‡»äº‹ä»¶ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ /ä¿®æ”¹åŠŸèƒ½
 124   4      
 125   4                      if (scan_para->click_delay_cnt > scan_para->click_delay_time)
 126   4                      { // æŒ‰é”®è¢«æŠ¬èµ·åŽå»¶æ—¶åˆ°
 127   5                          // TODO: åœ¨æ­¤å¯ä»¥æ·»åŠ ä»»æ„å¤šå‡»äº‹ä»¶
 128   5                          if (scan_para->click_cnt >= 5)
 129   5                          {
 130   6                              key_event = KEY_EVENT_FIRTH_CLICK; // äº”å‡»
 131   6                          }
 132   5                          else if (scan_para->click_cnt >= 4)
 133   5                          {
 134   6                              key_event = KEY_EVENT_FOURTH_CLICK; // 4å‡»
 135   6                          }
 136   5                          else if (scan_para->click_cnt >= 3)
 137   5                          {
 138   6                              key_event = KEY_EVENT_TRIPLE_CLICK; // ä¸‰å‡»
 139   6                          }
 140   5                          else if (scan_para->click_cnt >= 2)
 141   5                          {
 142   6                              key_event = KEY_EVENT_DOUBLE_CLICK; // åŒå‡»
 143   6                          }
 144   5                          else
 145   5                          {
 146   6                              key_event = KEY_EVENT_CLICK; // å•å‡»
 147   6                          }
 148   5                          key_value = scan_para->notify_value;
 149   5      
 150   5                          // goto _notify;
 151   5                          key_scan_status = KEY_SCAN_STATUS_TO_NOTIFY;
 152   5                      }
 153   4                      else
 154   4                      { // æŒ‰é”®æŠ¬èµ·åŽç­‰å¾…ä¸‹æ¬¡å»¶æ—¶æ—¶é—´æœªåˆ°
 155   5                          scan_para->click_delay_cnt++;
 156   5                          // goto _scan_end; // æŒ‰é”®æŠ¬èµ·åŽå»¶æ—¶æ—¶é—´æœªåˆ°, è¿”å›ž
 157   5                          key_scan_status = KEY_SCAN_STATUS_TO_END_OF_SCAN;
 158   5                      }
 159   4                  }
 160   3                  else
 161   3                  {
 162   4                      // goto _scan_end; // æ²¡æœ‰æŒ‰é”®éœ€è¦å¤„ç†
 163   4                      key_scan_status = KEY_SCAN_STATUS_TO_END_OF_SCAN;
 164   4                  }
 165   3              }
 166   2              else
 167   2              {
 168   3                  // last_key = valid_key; cur_key = valid_key, press_cntç´¯åŠ ç”¨äºŽåˆ¤æ–­longå’Œhold
 169   3                  scan_para->press_cnt++;
 170   3                  if (scan_para->press_cnt == scan_para->long_time)
 171   3                  {
C51 COMPILER V9.60.7.0   KEY_DRIVER                                                        05/21/2025 18:01:22 PAGE 4   

 172   4                      key_event = KEY_EVENT_LONG;
 173   4                  }
 174   3                  else if (scan_para->press_cnt == scan_para->hold_time)
 175   3                  {
 176   4                      key_event = KEY_EVENT_HOLD;
 177   4                      scan_para->press_cnt = scan_para->long_time;
 178   4                  }
 179   3                  else
 180   3                  {
 181   4                      // goto _scan_end; // press_cntæ²¡åˆ°é•¿æŒ‰å’ŒHOLDæ¬¡æ•°, è¿”å›ž
 182   4                      key_scan_status = KEY_SCAN_STATUS_TO_END_OF_SCAN;
 183   4                  }
 184   3                  // press_cntæ²¡åˆ°é•¿æŒ‰å’ŒHOLDæ¬¡æ•°, å‘æ¶ˆæ¯
 185   3                  key_value = cur_key_value;
 186   3                  // goto _notify;
 187   3                  key_scan_status = KEY_SCAN_STATUS_TO_NOTIFY;
 188   3              }
 189   2          }
 190   1      
 191   1      // _notify:
 192   1      
 193   1          if (KEY_SCAN_STATUS_TO_END_OF_SCAN != key_scan_status)
 194   1          {
 195   2              if (KEY_TYPE_AD == scan_para->key_type) // å¦‚æžœæ˜¯adæŒ‰é”®
 196   2              {
 197   3                  scan_para->click_cnt = 0;         // æŒ‰ä¸‹æ¬¡æ•°æ¸…0
 198   3                  scan_para->notify_value = NO_KEY; // åœ¨å»¶æ—¶çš„å¾…å‘é€æŒ‰é”®å€¼æ¸…é›¶
 199   3      
 200   3                  scan_para->latest_key_val = key_value;   // å­˜æ”¾å¾—åˆ°çš„æŒ‰é”®é”®å€¼
 201   3                  scan_para->latest_key_event = key_event; // å­˜æ”¾å¾—åˆ°çš„æŒ‰é”®äº‹ä»¶
 202   3              }
 203   2              else if (KEY_TYPE_TOUCH == scan_para->key_type) // å¦‚æžœæ˜¯è§¦æ‘¸æŒ‰é”®
 204   2              {
 205   3              }
 206   2              // else if (key_event_remap(&e))
 207   2              // {
 208   2              //     sys_event_notify(&e);
 209   2              // }
 210   2          }
 211   1      
 212   1      // _scan_end:
 213   1          scan_para->last_key = cur_key_value;
 214   1          return;
 215   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    560    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      1       6
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
