C51 COMPILER V9.60.7.0   TMR1                                                              05/24/2025 16:58:00 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE TMR1
OBJECT MODULE PLACED IN .\Release\Objects\tmr1.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\Hardware\tmr1.c LARGE OPTIMIZE(9,SIZE) BROWSE ORDER INTVECTOR(0X00
                    -0C) INCDIR(..\..\Libraries\Include;..\..\User;..\..\User\lib;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Rele
                    -ase\Listings\tmr1.lst) OBJECT(.\Release\Objects\tmr1.obj)

line level    source

   1          #include "tmr1.h"
   2          
   3          // #define TMR1_CNT_TIME 152 // 152 * 0.65625us çº¦ç­‰äº100us
   4          
   5          // å®šæ—¶å™¨å®šæ—¶å‘¨æœŸ (å•ä½:Hz)
   6          // å‘¨æœŸå€¼ = ç³»ç»Ÿæ—¶é’Ÿ / å®šæ—¶å™¨åˆ†é¢‘ / é¢‘ç‡ - 1
   7          #define TMR1_PERIOD (SYSCLK / 128 / 1000 - 1) // 1000Hz,1ms
   8          
   9          // volatile bit tmr1_flag = 0; // TMR1ä¸­æ–­æœåŠ¡å‡½æ•°ä¸­ä¼šç½®ä½çš„æ ‡å¿—ä½
  10          volatile u32 tmr1_cnt = 0; // å®šæ—¶å™¨TMR1çš„è®¡æ•°å€¼ï¼ˆæ¯æ¬¡åœ¨ä¸­æ–­æœåŠ¡å‡½æ•°ä¸­ä¼šåŠ ä¸€ï¼‰
  11          
  12          /**
  13           * @brief é…ç½®å®šæ—¶å™¨TMR1ï¼Œé…ç½®å®Œæˆåï¼Œå®šæ—¶å™¨é»˜è®¤å…³é—­
  14           */
  15          void tmr1_config(void)
  16          {
  17   1          __SetIRQnIP(TMR1_IRQn, TMR1_IQn_CFG); // è®¾ç½®ä¸­æ–­ä¼˜å…ˆçº§ï¼ˆTMR1ï¼‰
  18   1          __DisableIRQ(TMR1_IRQn);              // ç¦ç”¨ä¸­æ–­
  19   1          IE_EA = 1;                            // æ‰“å¼€æ€»ä¸­æ–­
  20   1      
  21   1          TMR_ALLCON = TMR1_CNT_CLR(0x1); // æ¸…é™¤è®¡æ•°å€¼
  22   1      
  23   1          TMR1_CONL &= ~TMR_PRESCALE_SEL(0x07); // æ¸…é™¤TMR1çš„é¢„åˆ†é¢‘é…ç½®å¯„å­˜å™¨
  24   1          TMR1_CONL |= TMR_PRESCALE_SEL(0x07);  // å®šæ—¶å™¨é¢„åˆ†é¢‘
  25   1          TMR1_CONL &= ~TMR_MODE_SEL(0x03);     // æ¸…é™¤TMR1çš„æ¨¡å¼é…ç½®å¯„å­˜å™¨
  26   1          TMR1_CONL |= TMR_MODE_SEL(0x01);      // é…ç½®TMR1çš„æ¨¡å¼ä¸ºè®¡æ•°å™¨æ¨¡å¼ï¼Œæœ€åå¯¹ç³»ç»Ÿæ—¶é’Ÿ
             -çš„è„‰å†²è¿›è¡Œè®¡æ•°
  27   1      
  28   1          TMR1_CONH &= ~TMR_PRD_PND(0x01); // æ¸…é™¤TMR1çš„è®¡æ•°æ ‡å¿—ä½ï¼Œè¡¨ç¤ºæœªå®Œæˆè®¡æ•°
  29   1          TMR1_CONH |= TMR_PRD_IRQ_EN(1);  // ä½¿èƒ½TMR1çš„è®¡æ•°ä¸­æ–­
  30   1      
  31   1          // é…ç½®TMR1çš„è®¡æ•°å‘¨æœŸ
  32   1          TMR1_PRH = TMR_PERIOD_VAL_H((TMR1_PERIOD >> 8) & 0xFF); // å‘¨æœŸå€¼
  33   1          TMR1_PRL = TMR_PERIOD_VAL_L((TMR1_PERIOD >> 0) & 0xFF);
  34   1      
  35   1          TMR1_CONL &= ~(TMR_SOURCE_SEL(0x07)); // æ¸…é™¤TMR1çš„æ—¶é’Ÿæºé…ç½®å¯„å­˜å™¨
  36   1          TMR1_CONL |= TMR_SOURCE_SEL(0x05);    // é…ç½®TMR1çš„æ—¶é’Ÿæºï¼Œä¸ç”¨ä»»ä½•æ—¶é’Ÿ
  37   1      }
  38          
  39          /**
  40           * @brief å¼€å¯å®šæ—¶å™¨TMR1ï¼Œå¼€å§‹è®¡æ—¶
  41           */
  42          void tmr1_enable(void)
  43          {
  44   1          // é‡æ–°ç»™TMR1é…ç½®æ—¶é’Ÿ
  45   1          TMR1_CONL &= ~(TMR_SOURCE_SEL(0x07)); // æ¸…é™¤å®šæ—¶å™¨çš„æ—¶é’Ÿæºé…ç½®å¯„å­˜å™¨
  46   1          TMR1_CONL |= TMR_SOURCE_SEL(0x06);    // é…ç½®å®šæ—¶å™¨çš„æ—¶é’Ÿæºï¼Œä½¿ç”¨ç³»ç»Ÿæ—¶é’Ÿ
  47   1      
  48   1          __EnableIRQ(TMR1_IRQn); // ä½¿èƒ½ä¸­æ–­
  49   1          IE_EA = 1;              // æ‰“å¼€æ€»ä¸­æ–­
  50   1      }
  51          
  52          #if 0  // void tmr1_disable(void)
C51 COMPILER V9.60.7.0   TMR1                                                              05/24/2025 16:58:00 PAGE 2   

              /**
               * @brief å…³é—­å®šæ—¶å™¨ï¼Œæ¸…ç©ºè®¡æ•°å€¼
               */
              void tmr1_disable(void)
              {
                  // ä¸ç»™å®šæ—¶å™¨æä¾›æ—¶é’Ÿï¼Œè®©å®ƒåœæ­¢è®¡æ•°
                  TMR1_CONL &= ~(TMR_SOURCE_SEL(0x07)); // æ¸…é™¤å®šæ—¶å™¨çš„æ—¶é’Ÿæºé…ç½®å¯„å­˜å™¨
                  TMR1_CONL |= TMR_SOURCE_SEL(0x05);    // é…ç½®å®šæ—¶å™¨çš„æ—¶é’Ÿæºï¼Œä¸ç”¨ä»»ä½•æ—¶é’Ÿ
              
                  TMR_ALLCON = TMR1_CNT_CLR(0x1); // æ¸…é™¤è®¡æ•°å€¼
              
                  __DisableIRQ(TMR1_IRQn); // å…³é—­ä¸­æ–­ï¼ˆä¸ä½¿èƒ½ä¸­æ–­ï¼‰
              }
              #endif // void tmr1_disable(void)
  67          
  68          void heart_beat_handle(void)
  69          {
  70   1          static volatile u32 old_time_ms_cnt = 0; //
  71   1          volatile u32 cur_time_ms_cnt = tmr1_cnt; // å…ˆè¯»å‡ºè®¡æ—¶,é˜²æ­¢è¢«ä¸­æ–­æ‰“æ–­
  72   1          volatile u32 diff_ms_cnt = 0;
  73   1          tmr1_cnt = 0;                                    // è¯»å‡ºè®¡æ—¶å,ç«‹åˆ»æ¸…é™¤å®šæ—¶å™¨çš„è®¡æ—¶
  74   1          diff_ms_cnt = cur_time_ms_cnt - old_time_ms_cnt; // è®¡ç®—æ—¶é—´å·®
  75   1          old_time_ms_cnt = 0;
  76   1      
  77   1          if (pin_level_scan_time_cnt < 65535) // é˜²æ­¢è®¡æ•°æº¢å‡º
  78   1          {
  79   2              // pin_level_scan_time_cnt++;
  80   2              pin_level_scan_time_cnt += diff_ms_cnt;
  81   2          }
  82   1      
  83   1          if (engine_scan_time_cnt < 65535 - diff_ms_cnt) // é˜²æ­¢è®¡æ•°æº¢å‡º
  84   1          {
  85   2              // engine_scan_time_cnt++;
  86   2              engine_scan_time_cnt += diff_ms_cnt;
  87   2              if (engine_scan_time_cnt >= ENGINE_SPEED_SCAN_TIME_MS) // å¦‚æœå·²ç»åˆ°äº†ç´¯è®¡çš„æ—¶é—´
  88   2              {
  89   3                  engine_actual_scan_time_cnt = engine_scan_time_cnt; // æ›´æ–°å®é™…çš„æ‰«ææ£€æµ‹æ—¶é—´
  90   3                  engine_scan_time_cnt = 0;
  91   3                  // detect_engine_pulse_cnt[1] += detect_engine_pulse_cnt[0]; // å°†å¦ä¸€ä¸ªå®šæ—¶å™¨ä¸­æ–­æ‰«
             -æåˆ°çš„è„‰å†²æ›´æ–°åˆ°[1]
  92   3                  // ä¸èƒ½åœ¨å®šæ—¶å™¨ä¸­æ–­å†…ç´¯åŠ è„‰å†²è®¡æ•°ï¼Œä¸»å¾ªç¯æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œç›¸å…³çš„è®¡æ
             -•°å‡½æ•°å°±ä¸èƒ½å®šæœŸå–åˆ°è¿™ä¸ªå€¼ï¼Œ
  93   3                  // ä¼šå½±å“è®¡ç®—ç»“æœï¼Œå¯èƒ½å¤šåŠ äº†å‡ ä¸ªè„‰å†²è®¡æ•°
  94   3                  // ä¸‹é¢ç›´æ¥è®©æ•°æ®è¦†ç›–ï¼Œå¦‚æœè®¡ç®—å‡½æ•°æ²¡æœ‰åŠæ—¶å–åˆ°æ•°å€¼ï¼Œä¹Ÿä¸å½±å“è®¡ç
             -®—ç»“æœ
  95   3                  detect_engine_pulse_cnt[1] = detect_engine_pulse_cnt[0]; // å°†å¦ä¸€ä¸ªå®šæ—¶å™¨ä¸­æ–­æ‰«æå
             -ˆ°çš„è„‰å†²æ›´æ–°åˆ°[1]
  96   3                  detect_engine_pulse_cnt[0] = 0;
  97   3                  flag_is_update_engine_pulse_cnt = 1; // è¡¨ç¤ºæœ‰æ•°æ®æ›´æ–°
  98   3              }
  99   2          }
 100   1      
 101   1          if (speed_scan_time_cnt < 65535 - diff_ms_cnt) // é˜²æ­¢è®¡æ•°æº¢å‡º
 102   1          {
 103   2              // speed_scan_time_cnt++;
 104   2              speed_scan_time_cnt += diff_ms_cnt;
 105   2              if (speed_scan_time_cnt >= SPEED_SCAN_TIME_MS) // å¦‚æœç»è¿‡äº† xx ms
 106   2              {
 107   3                  speed_actual_scan_time_cnt = speed_scan_time_cnt; // æ›´æ–°å®é™…çš„æ‰«ææ£€æµ‹æ—¶é—´
 108   3                  speed_scan_time_cnt = 0;
 109   3                  // detect_speed_pulse_cnt[1] += detect_speed_pulse_cnt[0]; // å°†å¦ä¸€ä¸ªå®šæ—¶å™¨ä¸­æ–­æ‰«æ
             -åˆ°çš„è„‰å†²æ›´æ–°åˆ°[1]
C51 COMPILER V9.60.7.0   TMR1                                                              05/24/2025 16:58:00 PAGE 3   

 110   3                  // ä¸èƒ½åœ¨å®šæ—¶å™¨ä¸­æ–­å†…ç´¯åŠ è„‰å†²è®¡æ•°ï¼Œä¸»å¾ªç¯æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œç›¸å…³çš„è®¡æ
             -•°å‡½æ•°å°±ä¸èƒ½å®šæœŸå–åˆ°è¿™ä¸ªå€¼ï¼Œ
 111   3                  // ä¼šå½±å“è®¡ç®—ç»“æœï¼Œå¯èƒ½å¤šåŠ äº†å‡ ä¸ªè„‰å†²è®¡æ•°
 112   3                  // ä¸‹é¢ç›´æ¥è®©æ•°æ®è¦†ç›–ï¼Œå¦‚æœè®¡ç®—å‡½æ•°æ²¡æœ‰åŠæ—¶å–åˆ°æ•°å€¼ï¼Œä¹Ÿä¸å½±å“è®¡ç
             -®—ç»“æœ
 113   3                  detect_speed_pulse_cnt[1] = detect_speed_pulse_cnt[0]; // å°†å¦ä¸€ä¸ªå®šæ—¶å™¨ä¸­æ–­æ‰«æåˆ°
             -çš„è„‰å†²æ›´æ–°åˆ°[1]
 114   3                  detect_speed_pulse_cnt[0] = 0;                         //
 115   3                  flag_is_update_speed_pulse_cnt = 1;                    // è¡¨ç¤ºæœ‰æ•°æ®æ›´æ–°
 116   3              }
 117   2          }
 118   1      
 119   1          if (mileage_save_time_cnt < 4294967295 - diff_ms_cnt) // é˜²æ­¢è®¡æ•°æº¢å‡º
 120   1          {
 121   2              // mileage_save_time_cnt++;
 122   2              mileage_save_time_cnt += diff_ms_cnt;
 123   2          }
 124   1      
 125   1          if (fuel_capacity_scan_cnt < 4294967295 - diff_ms_cnt) // é˜²æ­¢è®¡æ•°æº¢å‡º
 126   1          {
 127   2              // fuel_capacity_scan_cnt++;
 128   2              fuel_capacity_scan_cnt += diff_ms_cnt;
 129   2          }
 130   1      
 131   1          if (synchronous_request_status == SYN_REQUEST_STATUS_HANDLING)
 132   1          {
 133   2              // synchronous_request_time_cnt++; // åŒæ­¥è¯·æ±‚çš„å†·å´è®¡æ—¶
 134   2              synchronous_request_time_cnt += diff_ms_cnt; // åŒæ­¥è¯·æ±‚çš„å†·å´è®¡æ—¶
 135   2              if (synchronous_request_time_cnt >= 2500)
 136   2              {
 137   3                  // å¦‚æœæ¥æ”¶åŒæ­¥è¯·æ±‚å·²ç»è¿‡äº† xx sï¼Œæ¸…é™¤å†·å´çŠ¶æ€
 138   3                  synchronous_request_time_cnt = 0;
 139   3                  synchronous_request_status = SYN_REQUEST_STATUS_NONE;
 140   3              }
 141   2          }
 142   1      
 143   1          if (update_date_status == UPDATE_STATUS_HANDLING)
 144   1          {
 145   2              // å¦‚æœæ›´æ–°æ—¥æœŸè¿›å…¥å†·å´çŠ¶æ€ï¼Œè¿›è¡Œå†·å´è®¡æ—¶
 146   2              // update_date_cooling_cnt++;
 147   2              update_date_cooling_cnt += diff_ms_cnt;
 148   2              if (update_date_cooling_cnt >= 100) // xx ms
 149   2              {
 150   3                  // è¿‡äº†å†·å´æ—¶é—´ï¼Œé€€å‡ºå†·å´çŠ¶æ€
 151   3                  update_date_cooling_cnt = 0;
 152   3                  update_date_status = UPDATE_STATUS_NONE;
 153   3              }
 154   2          }
 155   1      
 156   1          if (update_time_status == UPDATE_STATUS_HANDLING)
 157   1          {
 158   2              // å¦‚æœæ›´æ–°æ—¶é—´è¿›å…¥å†·å´çŠ¶æ€ï¼Œè¿›è¡Œå†·å´è®¡æ—¶
 159   2              // update_time_cooling_cnt++;
 160   2              update_time_cooling_cnt += diff_ms_cnt;
 161   2              if (update_time_cooling_cnt >= 100) // xx ms
 162   2              {
 163   3                  // è¿‡äº†å†·å´æ—¶é—´ï¼Œé€€å‡ºå†·å´çŠ¶æ€
 164   3                  update_time_cooling_cnt = 0;
 165   3                  update_time_status = UPDATE_STATUS_NONE;
 166   3              }
 167   2          }
 168   1      }
C51 COMPILER V9.60.7.0   TMR1                                                              05/24/2025 16:58:00 PAGE 4   

 169          
 170          // TMR1ä¸­æ–­æœåŠ¡å‡½æ•°
 171          void TIMR1_IRQHandler(void) interrupt TMR1_IRQn
 172          {
 173   1          // è¿›å…¥ä¸­æ–­è®¾ç½®IPï¼Œä¸å¯åˆ é™¤
 174   1          __IRQnIPnPush(TMR1_IRQn);
 175   1      
 176   1          /*
 177   1              æµ‹è¯•ä¸­æ–­æŒç»­æ—¶é—´
 178   1              å†…éƒ¨æœªè°ƒç”¨å‡½æ•°ï¼Œçº¦           74.5us,
 179   1              è°ƒç”¨engine_speed_scan()æ—¶çº¦ 200us,
 180   1              è°ƒç”¨speed_scan()æ—¶çº¦        271us,
 181   1              ä¸¤ä¸ªä¸€èµ·è°ƒç”¨ï¼Œçº¦             426us,
 182   1      
 183   1              å°† engine_speed_scan()å’Œspeed_scan()æ”¾åˆ°ä¸»å‡½æ•°æ¥è®¡ç®—ï¼Œ
 184   1              æœ€çŸ­ç”¨æ—¶çº¦ 43usï¼Œ
 185   1              ç›¸ç»§æ‰§è¡Œäº†engine_speed_scanå’Œspeed_scanå¯¹åº”çš„æ¡ä»¶ï¼Œè¿›è¡Œæ›´æ–°æ—¶ï¼Œçº¦ 75us
 186   1      
 187   1              å°† å¯¹å…¶ä»–åŠŸèƒ½çš„æ—¶é—´è¿›è¡Œè®¡æ•°çš„æ“ä½œå…¨éƒ¨è½¬ç§»åˆ°å¤–éƒ¨å‡½æ•°,åªåœ¨è¯¥ä¸­æ–­å¯¹ tm
             -r1_cnt åŠ ä¸€,
 188   1              çº¦ 5us
 189   1          */
 190   1          // P20 = 1;
 191   1      
 192   1          // ---------------- ç”¨æˆ·å‡½æ•°å¤„ç† -------------------
 193   1      
 194   1          // å‘¨æœŸä¸­æ–­
 195   1          if (TMR1_CONH & TMR_PRD_PND(0x1))
 196   1          {
 197   2              TMR1_CONH |= TMR_PRD_PND(0x1); // æ¸…é™¤pending
 198   2      
 199   2              tmr1_cnt++;
 200   2      
 201   2              {
 202   3                  // static u8 cnt = 0;
 203   3                  // cnt++;
 204   3                  // if (cnt >= TOUCH_KEY_SCAN_CIRCLE_TIMES) // xx ms
 205   3                  // {
 206   3                  //     cnt = 0;
 207   3                  //     // flag_is_touch_key_scan_circle_arrived = 1; // è¡¨ç¤ºæ‰«æå‘¨æœŸåˆ°æ¥ï¼Œæ‰§è¡Œä¸€æ¬
             -¡æŒ‰é”®æ‰«æ
 208   3      
 209   3                  //     // {
 210   3                  //     //     static u8 send_cnt = 0;
 211   3                  //     //     send_cnt++;
 212   3                  //     //     if (send_cnt >= 100)
 213   3                  //     //     {
 214   3                  //     //         send_cnt = 0;
 215   3                  //     //         printf("touch key scan\n");
 216   3                  //     //     }
 217   3                  //     // }
 218   3                  // }
 219   3      
 220   3                  // åœ¨å®šæ—¶å™¨æ³¨å†ŒæŒ‰é”®æ‰«æï¼š
 221   3                  if (ad_key_para.cur_scan_times < 255)
 222   3                  {
 223   4                      ad_key_para.cur_scan_times++;
 224   4                  }
 225   3      
 226   3                  if (touch_key_para.cur_scan_times < 255)
 227   3                  {
 228   4                      touch_key_para.cur_scan_times++;
C51 COMPILER V9.60.7.0   TMR1                                                              05/24/2025 16:58:00 PAGE 5   

 229   4                  }
 230   3              }
 231   2          }
 232   1      
 233   1          // P20 = 0;// æµ‹è¯•ä¸­æ–­æŒç»­æ—¶é—´
 234   1          // é€€å‡ºä¸­æ–­è®¾ç½®IPï¼Œä¸å¯åˆ é™¤
 235   1          __IRQnIPnPop(TMR1_IRQn);
 236   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    673    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      8       8
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
